<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title> Tìm hiểu về Proxy trong ES6 · Learn and Share</title><meta name="description" content="Tìm hiểu về Proxy trong ES6 - Hung Tan Nguyen"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#FB4D42"><meta name="google-site-verification" content="rk-Nc1c8xi1CdZ0ZQIVV-ifsndGrHanIuSHI-yTHZYE"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/zoom.css"><meta property="og:title" content="Tìm hiểu về Proxy trong ES6"><meta property="og:image" content="https://res.cloudinary.com/duqeezi8j/image/upload/v1530343978/ehkoo/dragon_knight_by_peridott.jpg"><meta property="og:description" content="Nói về ES6 có lẽ chúng ta đã quá quen thuộc với các khái niệm như const và let, hàm mũi tên, class hay những tính năng hay ho hấp dẫn khác. Ngoài ra, ES6 cũng kèm theo những tính năng ít người biết hơn nhưng cũng rất thú vị, và một trong số đó là Proxy."></head><body><div class="wrap"><div class="header"><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nthung2112" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item search-form-input"><div class="search-icon"><div class="search-icon__circle"></div><div class="search-icon__rectangle"></div></div></li></ul><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" placeholder="Type something..." class="ins-search-input"><span class="ins-close ins-selectable"><div class="close-icon"><div class="close-icon__x"></div><div class="close-icon__y"></div></div></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>var rootUrl = "/";
var contentUrl = '/content.json';
(function (window) {
  var INSIGHT_CONFIG = {
  TRANSLATION: {
      POSTS:'Posts',
      PAGES: 'Pages',
      CATEGORIES: 'Categories',
      TAGS: 'Tags',
      UNTITLED: '(Untitled)'
    },
    ROOT_URL: rootUrl,
    CONTENT_URL: contentUrl,
  };
  window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);</script></div></div><section class="container"><div class="post"><article class="post-block"><div class="wrap"><h1 class="post-title">Tìm hiểu về Proxy trong ES6</h1><h2 class="post-subtitle"></h2><header class="post-info">Jul 8, 2018<div class="tags"><a href="/tags/javascript" class="tag-link">#javascript</a></div><div class="fb-ir-time"><time dateTime="2018-07-08T08:57:00.000Z" class="op-modified"></time><time dateTime="2018-07-08T08:57:00.000Z" class="op-published"></time></div></header></div><div class="post-banner"><img src="https://res.cloudinary.com/duqeezi8j/image/upload/v1530343978/ehkoo/dragon_knight_by_peridott.jpg"></div><div class="wrap"><div class="post-content"><p>Nói về ES6 có lẽ chúng ta đã quá quen thuộc với các khái niệm như const và let, hàm mũi tên, class hay <a href="https://ehkoo.com/bai-viet/tong-hop-tinh-nang-noi-bat-es6" target="_blank" rel="noopener">những tính năng hay ho hấp dẫn khác</a>. Ngoài ra, ES6 cũng kèm theo những tính năng ít người biết hơn nhưng cũng rất thú vị, và một trong số đó là Proxy.<br><a id="more"></a></p>
<h3 id="Proxy-la-gi"><a href="#Proxy-la-gi" class="headerlink" title="Proxy là gì?"></a>Proxy là gì?</h3><p>Proxy là một class được giới thiệu từ ES6, cho phép bạn can thiệp và thay đổi hành vi của một đối tượng (object). Các hành vi này bao gồm: truy xuất/thiết lập thuộc tính của một đối tượng, thay đổi prototype, gọi hàm, khởi tạo đối tượng bằng từ khóa new… Để hiểu rõ hơn về khái niệm, bạn có thể xem qua ví dụ sau:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> u = &#123; <span class="attr">name</span>: <span class="string">'Công Tằng Tôn Nữ Tạ Thị Tòn Ten'</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Thiết lập proxy cho đối tượng `u`</span></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(u, &#123;</span><br><span class="line">  <span class="comment">// `get` là một trap, sẽ được gọi khi truy xuất đến thuộc tính</span></span><br><span class="line">  <span class="comment">// của đối tượng</span></span><br><span class="line">  get(target, prop, receiver) &#123;</span><br><span class="line">    <span class="comment">// Thay đổi hành vi khi truy xuất đến một thuộc tính: Nếu là</span></span><br><span class="line">    <span class="comment">// chuỗi, chuyển sang chữ hoa</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target[prop] === <span class="string">'string'</span>) <span class="keyword">return</span> target[prop].toUpperCase()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target[prop]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(p.name) <span class="comment">// CÔNG TẰNG TÔN NỮ TẠ THỊ TÒN TEN</span></span><br><span class="line">p.email = <span class="string">'ta.thi@ton.ten'</span></span><br><span class="line"><span class="built_in">console</span>.log(p.email) <span class="comment">// TA.THI@TON.TEN</span></span><br></pre></td></tr></table></figure>
<p>Chúng ta có thể áp dụng Proxy cho bất cứ object nào trong JavaScript, kể cả mảng, hàm hay một proxy khác.</p>
<blockquote>
<p><strong>Có thể bạn thừa biết</strong><br>Một hàm trong JavaScript là một thể hiện của lớp Function.</p>
</blockquote>
<p>Hiện tại Proxy đã được hỗ trợ bởi các trình duyệt xịn (nghĩa là không có IE đó) và node.js v6 trở đi.</p>
<blockquote>
<p><strong>Tin vắn</strong><br>Phiên bản 5.0 của <a href="https://github.com/mobxjs/mobx" target="_blank" rel="noopener">MobX</a> đã hoàn toàn sử dụng ES6 Proxy.</p>
</blockquote>
<h3 id="Su-dung-nhu-the-nao"><a href="#Su-dung-nhu-the-nao" class="headerlink" title="Sử dụng như thế nào?"></a>Sử dụng như thế nào?</h3><p>Trước hết, hãy xem qua những thuật ngữ thông dụng khi làm việc với Proxy:</p>
<ul>
<li><strong>target</strong>: là đối tượng sẽ được áp dụng proxy vào</li>
<li><strong>traps</strong>: là những phương thức giúp bạn thay đổi hành vi của đối tượng</li>
<li><strong>handler</strong>: là một object chứa các traps, được đưa vào hàm dựng của lớp Proxy</li>
</ul>
<p>Để khởi tạo proxy, bạn dùng new Proxy(target, handler) như bên dưới:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler)</span><br></pre></td></tr></table></figure>
<p>Chúng ta sẽ cùng đi qua những traps thông dụng.</p>
<h4 id="handler-get-va-handler-set"><a href="#handler-get-va-handler-set" class="headerlink" title="handler.get() và handler.set()"></a>handler.get() và handler.set()</h4><p>Như tên gọi, handler.get() và handler.set() cho phép bạn can thiệp khi truy xuất và thiết lập giá trị một thuộc tính của đối tượng.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// property: tên của thuộc tính được truy xuất</span></span><br><span class="line"><span class="comment">// receiver: đối tượng sau khi đã được gắn proxy</span></span><br><span class="line">handler.get(target, property, receiver)</span><br><span class="line"></span><br><span class="line"><span class="comment">// value: giá trị sẽ được thiết lập cho thuộc tính</span></span><br><span class="line"><span class="comment">// handler.set() phải trả về một giá trị boolean. Nếu là true thì xem như thiết lập</span></span><br><span class="line"><span class="comment">// thành công, ngược lại nếu là false thì xảy ra lỗi TypeError.</span></span><br><span class="line">handler.set(target, property, value, receiver)</span><br></pre></td></tr></table></figure>
<p>Chúng ta có thể dùng handler.set() để kiểm tra tính đúng đắn dữ liệu (data validation) trên thuộc tính của đối tượng. Chẳng hạn như:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> u = &#123; <span class="attr">age</span>: <span class="literal">null</span> &#125;</span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(u, &#123;</span><br><span class="line">  set(target, prop, val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prop === <span class="string">'age'</span> &amp;&amp; <span class="keyword">typeof</span> val !== <span class="string">'number'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Age must be a number'</span>)</span><br><span class="line"></span><br><span class="line">    target[prop] = val</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p.age = <span class="string">'10'</span> <span class="comment">// Error: Age must be a number</span></span><br><span class="line">p.age = <span class="number">10</span>   <span class="comment">// OK!</span></span><br></pre></td></tr></table></figure>
<h4 id="handler-defineProperty-va-handler-deleteProperty"><a href="#handler-defineProperty-va-handler-deleteProperty" class="headerlink" title="handler.defineProperty() và handler.deleteProperty()"></a>handler.defineProperty() và handler.deleteProperty()</h4><p>handle.defineProperty(target, property, descriptor) là trap được kích hoạt khi sử dụng Object.defineProperty(). Phương thức này đòi hỏi phải trả về một giá trị boolean. Ví dụ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123; <span class="attr">foo</span>: <span class="number">1</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;, &#123;</span><br><span class="line">  defineProperty(target, property, descriptor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (property.startsWith(<span class="string">'_'</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Properties starting with _ are not allowed'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(...arguments)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p._hello = <span class="number">1</span> <span class="comment">// Error</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(p, <span class="string">'_hello'</span>, &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;) <span class="comment">// Error</span></span><br><span class="line"></span><br><span class="line">p.hello = <span class="number">1</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(p, <span class="string">'hello'</span>, &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>descriptor là một object quy định hành vi của thuộc tính được khai báo. Chi tiết về descriptor bạn có thể xem ở trang <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">MDN</a> hoặc hóng bài viết tiếp theo của Ehkoo.</p>
</blockquote>
<p>handle.deleteProperty(target, property) sẽ được kích hoạt khi thực hiện delete một thuộc tính. Phương thức này phải trả về true nếu quá trình xóa được chấp nhận. Ví dụ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123; <span class="attr">foo</span>: <span class="number">1</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;, &#123;</span><br><span class="line">  deleteProperty(target, property) &#123;</span><br><span class="line">    <span class="keyword">delete</span> target[property]</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;property&#125;</span> was removed`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> p.foo <span class="comment">// foo was removed</span></span><br><span class="line"><span class="keyword">delete</span> p.bar <span class="comment">// bar was removed</span></span><br></pre></td></tr></table></figure>
<h4 id="handler-has"><a href="#handler-has" class="headerlink" title="handler.has()"></a>handler.has()</h4><p>handler.has() sẽ được kích hoạt khi sử dụng in. Phương thức này cũng đòi hỏi phải trả về một giá trị boolean. Ví dụ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123; <span class="attr">_foo</span>: <span class="number">1</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;, &#123;</span><br><span class="line">  has(target, property) &#123;</span><br><span class="line">    <span class="keyword">if</span> (property.startsWith(<span class="string">'_'</span>)) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> property <span class="keyword">in</span> target</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'bar'</span> <span class="keyword">in</span> p) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'_foo'</span> <span class="keyword">in</span> p) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h4 id="handler-apply"><a href="#handler-apply" class="headerlink" title="handler.apply()"></a>handler.apply()</h4><p>handler.apply(target, thisArg, args) là trap dành cho các hàm, sẽ được khởi động khi hàm được gọi. Ví dụ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b</span><br><span class="line"><span class="keyword">const</span> f = <span class="keyword">new</span> <span class="built_in">Proxy</span>(sum, &#123;</span><br><span class="line">  apply(target, thisArg, args) &#123;</span><br><span class="line">    <span class="keyword">const</span> [a, b] = args</span><br><span class="line">    <span class="keyword">return</span> target.call(thisArg, a * <span class="number">2</span>, b * <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>, <span class="number">2</span>) <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>
<h4 id="handler-construct"><a href="#handler-construct" class="headerlink" title="handler.construct()"></a>handler.construct()</h4><p>handler.construct(target, args) là trap sẽ được gọi khi khởi tạo đối tượng bằng new. Ví dụ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(username) &#123;</span><br><span class="line">    <span class="keyword">this</span>.username = username</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PUser = <span class="keyword">new</span> <span class="built_in">Proxy</span>(User, &#123;</span><br><span class="line">  construct(target, args) &#123;</span><br><span class="line">    <span class="keyword">const</span> [username] = args</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> target(username.toUpperCase())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> u = <span class="keyword">new</span> PUser(<span class="string">'pikalong'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(u.username) <span class="comment">// PIKALONG</span></span><br></pre></td></tr></table></figure>
<h4 id="handler-getPrototypeOf-va-handler-setPrototypeOf"><a href="#handler-getPrototypeOf-va-handler-setPrototypeOf" class="headerlink" title="handler.getPrototypeOf() và handler.setPrototypeOf()"></a>handler.getPrototypeOf() và handler.setPrototypeOf()</h4><p>Như tên gọi, hai traps này sẽ được kích hoạt khi sử dụng Object.getPrototypeOf() và Object.setPrototypeOf() trên đối tượng.</p>
<blockquote>
<p><strong>Ghi chú</strong><br>Bên cạnh những traps được giới thiệu ở đây, còn có một số traps khác mà bạn có thể tham khảo ở trang <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener">MDN</a>.</p>
</blockquote>
<h3 id="Viet-thu-nao"><a href="#Viet-thu-nao" class="headerlink" title="Viết thử nào"></a>Viết thử nào</h3><p>Bạn có dùng thử <a href="http://www.chaijs.com/" target="_blank" rel="noopener">chai</a> chưa? Thư viện này hỗ trợ viết kiểm chứng (assertion) theo phong cách BDD/TDD, giống như thế này:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chai.expect</span></span><br><span class="line">expect(foo).to.be.a(<span class="string">'string'</span>)</span><br><span class="line">expect(foo).to.equal(<span class="string">'bar'</span>)</span><br><span class="line">expect(foo).to.have.lengthOf(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// hoặc chai.should</span></span><br><span class="line">foo.should.be.a(<span class="string">'string'</span>)</span><br><span class="line">foo.should.equal(<span class="string">'bar'</span>)</span><br><span class="line">foo.should.have.lengthOf(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>Cách thiết kế này rõ ràng giúp cho chương trình trở nên mạch lạc và dễ theo dõi vì câu kiểm chứng được viết như một câu tiếng Anh vậy. Chúng ta có thể bắt chước chai và thử viết một lớp Thing có những khả năng sau:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Khởi tạo một đối tượng của lớp Thing với tên là "Phương"</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="keyword">new</span> Thing(<span class="string">'Phương'</span>)</span><br><span class="line">t.name <span class="comment">// 'Phương'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Khai báo các thuộc tính boolean</span></span><br><span class="line">t.is_a.singer</span><br><span class="line">t.is_not_a.man</span><br><span class="line"></span><br><span class="line"><span class="comment">// Kiểm tra thuộc tính</span></span><br><span class="line">t.is_a_singer <span class="comment">// true</span></span><br><span class="line">t.is_a_man <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Khai báo phương thức</span></span><br><span class="line">t.can.sing(<span class="string">'Yêu hay không yêu không yêu hay yêu nói một lời'</span>)</span><br><span class="line">t.sing() <span class="comment">// Phương sings: Yêu hay không yêu không yêu hay yêu nói một lời</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Đây là một phần trong bài <a href="https://www.codewars.com/kata/5571d9fc11526780a000011a" target="_blank" rel="noopener">The builder of things</a> được lấy từ Codewars. Sau khi đọc hết bài viết này thì bạn hãy thử giải thử thách trên xem sao, bảo đảm kết quả không làm bạn thất vọng đâu.<br>Ngoài ra nếu bạn có tham gia Codewars thì đừng quên gia nhập clan Ehkoo nhé ;)</p>
</blockquote>
<p>Đầu tiên, để truy xuất thuộc tính name, chúng ta có thể nghĩ đến giải pháp “vô cùng rõ ràng và ngây thơ” sau:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Thing</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Đoạn code trên hoàn toàn hợp lý, nhưng sẽ không giúp chúng ta giải quyết những yêu cầu tiếp theo của bài toán. Phân tích kỹ một chút ta có thể thấy việc dùng Proxy là không thể tránh khỏi. Do đó để cài đặt t.name bằng Proxy, ta có thể viết lại thành:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Thing</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; name &#125;</span><br><span class="line">    <span class="keyword">return</span> proxify(<span class="keyword">this</span>, <span class="keyword">this</span>.state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hàm proxify() nhận vào một target và một object chứa state.</span></span><br><span class="line"><span class="comment">// State này sẽ được sử dụng để giải quyết những yêu cầu tiếp theo.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxify</span>(<span class="params">target, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    get(target, prop, receiver) &#123;</span><br><span class="line">      <span class="comment">// Nếu truy xuất đến thuộc tính `name`, lấy ra dữ liệu trong state</span></span><br><span class="line">      <span class="keyword">if</span> (prop === <span class="string">'name'</span>) <span class="keyword">return</span> state[prop]</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Còn lại thì sử dụng hành vi mặc định</span></span><br><span class="line">      <span class="keyword">return</span> target[prop]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> t = <span class="keyword">new</span> Thing(<span class="string">'Phương'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(t.name) <span class="comment">// Phương</span></span><br><span class="line"><span class="built_in">console</span>.log(t.age)  <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>
<p>Vậy là tạm ổn phần lấy name. Chúng ta xem tiếp đến hành vi tiếp theo của lớp Thing.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t.is_a.singer</span><br><span class="line">t.is_not_a.man</span><br><span class="line"></span><br><span class="line">t.is_a_singer <span class="comment">// true</span></span><br><span class="line">t.is_a_man <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>Hành vi này cho phép khai báo thuộc tính boolean trên đối tượng bằng cách sử dụng is_a cho giá trị true và is_not_a cho giá trị false. Sau đó ta có thể kiểm tra thuộc tính bằng cách truy xuất đến is_a_${prop}. Để cài đặt hành vi này, chúng ta có thể làm như sau:</p>
<ol>
<li>Khai báo thêm một khóa booleans: {} cho state. Khóa này đóng vai trò như một bảng tham chiếu giữa tên thuộc tính boolean và giá trị của nó, chẳng hạn như { singer: true, man: false }. Ngoài ra chúng ta cũng cần thêm vào state một cờ inBooleanMode: false.</li>
<li>Nếu prop là is_a hoặc is_not_a, bật cờ inBooleanMode: true</li>
<li>Nếu cờ inBooleanMode đang bật, thuộc tính tiếp theo sẽ là thuộc tính boolean. Do đó ta cập nhật booleans của state thành { …booleans, [prop]: state.booleanValue }</li>
</ol>
<p><img src="https://res.cloudinary.com/duqeezi8j/image/upload/v1530343401/ehkoo/proxy_iah0182.png" alt=""></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enterBooleanMode</span>(<span class="params">receiver, state, booleanValue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Bật cờ</span></span><br><span class="line">  state.inBooleanMode = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// Lưu lại giá trị boolean tùy thuộc vào là `is_a` hay `is_not_a`</span></span><br><span class="line">  state.booleanValue = booleanValue</span><br><span class="line">  <span class="keyword">return</span> receiver</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setBoolean</span>(<span class="params">receiver, state, prop</span>) </span>&#123;</span><br><span class="line">  state.booleans = &#123;...state.booleans, [prop]: state.booleanValue &#125;</span><br><span class="line">  <span class="comment">// Reset lại các giá trị</span></span><br><span class="line">  state.inBooleanMode = <span class="literal">false</span></span><br><span class="line">  state.booleanValue = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> receiver</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get(target, prop, receiver) &#123;</span><br><span class="line">  <span class="comment">// Đặt ở đây để tránh trường hợp gọi t.is_a.is_a</span></span><br><span class="line">  <span class="keyword">if</span> (state.inBooleanMode) <span class="keyword">return</span> setBoolean(<span class="keyword">this</span>, state, prop)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prop === <span class="string">'name'</span>) <span class="keyword">return</span> state[prop]</span><br><span class="line">  <span class="keyword">if</span> (prop === <span class="string">'is_a'</span>) <span class="keyword">return</span> enterBooleanMode(receiver, state, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">if</span> (prop === <span class="string">'is_not_a'</span>) <span class="keyword">return</span> enterBooleanMode(receiver, state, <span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">if</span> (prop.startsWith(<span class="string">'is_a_'</span>)) <span class="keyword">return</span> state.booleans[prop.replace(<span class="string">'is_a_'</span>, <span class="string">''</span>)]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target[prop]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kiểm tra thử.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> t = <span class="keyword">new</span> Thing(<span class="string">'Phương'</span>)</span><br><span class="line"></span><br><span class="line">t.is_a.singer</span><br><span class="line">t.is_not_a.man</span><br><span class="line"><span class="built_in">console</span>.log(t.is_a_singer) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(t.is_a_man)    <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>Để cài đặt hành vi tiếp theo, chúng ta cũng có thể làm tương tự như khai báo thuộc tính boolean bằng cách đặt thêm một cờ inDefineMethodMode và bật/tắt cờ này tương ứng. Bên cạnh đó chúng ta cũng đặt thêm một khóa methods trong state để chứa các phương thức được khai báo thông qua can.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get(target, prop, receiver) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (state.inDefineMethodMode) <span class="keyword">return</span> setMethod(receiver, state, prop)</span><br><span class="line">  <span class="keyword">if</span> (prop === <span class="string">'can'</span>) <span class="keyword">return</span> enterDefineMethodMode(receiver, state)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lấy ra phương thức được khai báo bởi `t.can`</span></span><br><span class="line">  <span class="keyword">if</span> (state.methods[prop]) <span class="keyword">return</span> state.methods[prop]</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ở đây có một chút khó khăn. Có thể thấy trong t.can.sing(phrase), sing phải là một hàm. Do đó giá trị trả về của setMethod() có thể được viết như sau:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setMethod</span>(<span class="params">receiver, state, prop</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Đừng quên tắt cờ sau khi cài đặt method</span></span><br><span class="line">  state.inDefineMethodMode = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">phrase</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Tạo ra hàm mới</span></span><br><span class="line">    <span class="keyword">const</span> f = <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;state.name&#125;</span> <span class="subst">$&#123;prop&#125;</span>: <span class="subst">$&#123;phrase&#125;</span>`</span></span><br><span class="line">    <span class="comment">// Lưu vào danh sách các phương thức được khai báo bởi `t.can`</span></span><br><span class="line">    state.methods = &#123; ...state.methods, [prop]: f &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t.can.sing(<span class="string">'Yêu hay không yêu không yêu hay yêu nói một lời'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(t.sing()) <span class="comment">// Phương sing: Yêu hay không yêu không yêu hay yêu nói một lời</span></span><br></pre></td></tr></table></figure>
<p>Vậy là được rồi. Chúng ta chỉ còn một bước nữa là chia “sing” sang ngôi thứ ba số ít “sings”, nhưng thôi cái này để bạn tự làm nhé. Bạn có thể xem đầy đủ mã nguồn <a href="https://repl.it/repls/MiniCornyEditors" target="_blank" rel="noopener">ở đây</a>.</p>
<h3 id="Ket"><a href="#Ket" class="headerlink" title="Kết"></a>Kết</h3><p>Proxy là một công cụ mạnh mẽ, giúp cho việc lập trình meta trong JavaScript trở nên dễ dàng hơn. Hi vọng bài viết này đã giúp bạn hiểu rõ hơn về Proxy và có thể ứng dụng nó trong công việc.</p>
<h4 id="Tham-khao"><a href="#Tham-khao" class="headerlink" title="Tham khảo"></a>Tham khảo</h4><p><em>Proxy - MDN</em> - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy</a></p>
<p><em>ES6 Proxies in Depth</em> - <a href="https://ponyfoo.com/articles/es6-proxies-in-depth" target="_blank" rel="noopener">https://ponyfoo.com/articles/es6-proxies-in-depth</a></p>
<span>Source: </span><a href="https://ehkoo.com/bai-viet/tim-hieu-ve-proxy-trong-es6" target="_blank" title="https://ehkoo.com/bai-viet/tim-hieu-ve-proxy-trong-es6" class="post-from">https://ehkoo.com/bai-viet/tim-hieu-ve-proxy-trong-es6</a></div></div></article></div></section><div class="wrap"><footer><div class="paginator"><a href="/2018/07/Lam-the-nao-de-thanh-thao-CSS-Grid-trong-nhay-mat.html" class="prev">NEXT</a><a href="/2018/07/Tim-Hieu-Map-Va-Set-Trong-Javascript.html" class="next">PREV</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://nthung2112.github.io">Hung Tan Nguyen</a>, unless otherwise noted.</p></div></footer></div><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-41935289-1",'auto');ga('send','pageview');</script><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script><script src="/js/zoom.js"></script><script src="/js/insight.js"></script></body></html>