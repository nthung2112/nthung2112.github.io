<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title> Using MySQL with Node.js & the mysql JavaScript Client · Learn and Share</title><meta name="description" content="Using MySQL with Node.js &amp; the mysql JavaScript Client - Hung Tan Nguyen"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#FB4D42"><meta name="google-site-verification" content="rk-Nc1c8xi1CdZ0ZQIVV-ifsndGrHanIuSHI-yTHZYE"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/zoom.css"><meta property="og:title" content="Using MySQL with Node.js &amp; the mysql JavaScript Client"><meta property="og:image"><meta property="og:description" content="NoSQL databases are all the rage these days and probably the preferred back-end for Node.js applications. But you shouldn’t architect your next project based on what’s hip and trendy, rather the type of database to be used should depend on the project’s requirements. If your project involves dynamic table creation, real time inserts etc. then NoSQL is the way to go, but on the other hand, if your project deals with complex queries and transactions, then a SQL database makes much more sense.
In this tutorial, we’ll have a look at getting started with the mysql module — a Node.js driver for MySQL, written in JavaScript. I’ll explain how to use the module to connect to a MySQL database, perform the usual CRUD operations, before examining stored procedures and escaping user input.

This popular tutorial was updated on 11.07.2017. Changes include updating to ES6 syntax, addressing the fact that the node-mysql module was renamed, adding more beginner friendly instructions and adding a section on ORMs."></head><body><div class="wrap"><div class="header"><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nthung2112" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item search-form-input"><div class="search-icon"><div class="search-icon__circle"></div><div class="search-icon__rectangle"></div></div></li></ul><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" placeholder="Type something..." class="ins-search-input"><span class="ins-close ins-selectable"><div class="close-icon"><div class="close-icon__x"></div><div class="close-icon__y"></div></div></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>var rootUrl = "/";
var contentUrl = '/content.json';
(function (window) {
  var INSIGHT_CONFIG = {
  TRANSLATION: {
      POSTS:'Posts',
      PAGES: 'Pages',
      CATEGORIES: 'Categories',
      TAGS: 'Tags',
      UNTITLED: '(Untitled)'
    },
    ROOT_URL: rootUrl,
    CONTENT_URL: contentUrl,
  };
  window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);</script></div></div><section class="container"><div class="post"><article class="post-block"><div class="wrap"><h1 class="post-title">Using MySQL with Node.js & the mysql JavaScript Client</h1><h2 class="post-subtitle"></h2><header class="post-info">Jul 23, 2017<div class="tags"><a href="/tags/javascript" class="tag-link">#javascript</a><a href="/tags/nodejs" class="tag-link">#nodejs</a><a href="/tags/mysql" class="tag-link">#mysql</a></div><div class="fb-ir-time"><time datetime="2017-07-23T09:47:48.000Z" class="op-modified"></time><time datetime="2017-07-23T09:47:48.000Z" class="op-published"></time></div></header></div><div class="wrap"><div class="post-content"><p>NoSQL databases are all the rage these days and probably the preferred back-end for Node.js applications. But you shouldn’t architect your next project based on what’s hip and trendy, rather the type of database to be used should depend on the project’s requirements. If your project involves dynamic table creation, real time inserts etc. then NoSQL is the way to go, but on the other hand, if your project deals with complex queries and transactions, then a SQL database makes much more sense.</p>
<p>In this tutorial, we’ll have a look at getting started with the <a href="https://github.com/felixge/node-mysql" target="_blank" rel="noopener">mysql module</a> — a Node.js driver for MySQL, written in JavaScript. I’ll explain how to use the module to connect to a MySQL database, perform the usual CRUD operations, before examining stored procedures and escaping user input.</p>
<blockquote>
<p>This popular tutorial was updated on <strong>11.07.2017</strong>. Changes include updating to ES6 syntax, addressing the fact that the node-mysql module was renamed, adding more beginner friendly instructions and adding a section on ORMs.<br><a id="more"></a></p>
</blockquote>
<h2 id="Quick-Start-How-to-Use-MySQL-in-Node"><a href="#Quick-Start-How-to-Use-MySQL-in-Node" class="headerlink" title="Quick Start: How to Use MySQL in Node"></a>Quick Start: How to Use MySQL in Node</h2><p>Maybe you’ve arrived here looking for a quick leg up. If you’re just after a way to get up and running with MySQL in Node in as little time as possible, we got you covered!</p>
<p>Here’s how to use MySQL in Node in 5 easy steps:</p>
<ol>
<li>Create a new project: <code>mkdir mysql-test &amp;&amp; cd mysql-test</code></li>
<li>Create a <code>package.json</code> file: <code>npm init –y</code></li>
<li>Install the mysql module: <code>npm install mysql –save</code></li>
<li>Create an <code>app.js</code> file and copy in the snippet below.</li>
<li>Run the file: <code>node app.js</code>. Observe a “Connected!” message.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//app.js</span><br><span class="line"></span><br><span class="line">const mysql = require(&apos;mysql&apos;);</span><br><span class="line">const connection = mysql.createConnection(&#123;</span><br><span class="line">  host: &apos;localhost&apos;,</span><br><span class="line">  user: &apos;user&apos;,</span><br><span class="line">  password: &apos;password&apos;,</span><br><span class="line">  database: &apos;database name&apos;</span><br><span class="line">&#125;);</span><br><span class="line">connection.connect((err) =&gt; &#123;</span><br><span class="line">  if (err) throw err;</span><br><span class="line">  console.log(&apos;Connected!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Installing-the-mysql-Module"><a href="#Installing-the-mysql-Module" class="headerlink" title="Installing the mysql Module"></a>Installing the mysql Module</h2><p>Now let’s take a closer look at each of those steps. First of all we’re using the command line to create a new directory and navigate to it. Then we’re creating a <code>package.json</code> file using the command <code>npm init –y</code>. The <code>-y</code> flag means that npm will use only defaults and not prompt you for any options.</p>
<p>This step also assumes that you have Node and npm installed on your system. If this is not the case, then check out this SitePoint article to find out how to do that: <a href="https://www.sitepoint.com/quick-tip-multiple-versions-node-nvm/" target="_blank" rel="noopener">Install Multiple Versions of Node.js using nvm</a>.</p>
<p>After that, we’re installing the <a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener">mysql module</a> from npm and saving it as a project dependency. Project dependencies (as opposed to dev-dependencies) are those packages required for the application to run. You can read <a href="https://stackoverflow.com/q/22891211" target="_blank" rel="noopener">more about the differences between the two here</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir mysql-test</span><br><span class="line">cd mysql-test</span><br><span class="line">npm install mysql -y</span><br></pre></td></tr></table></figure>
<p>If you need further help using npm, then be sure to check out <a href="http://www.sitepoint.com/beginners-guide-node-package-manager/" target="_blank" rel="noopener">this guide</a>, or ask in <a href="http://community.sitepoint.com/c/javascript" target="_blank" rel="noopener">our forums</a>.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>Before we get on to connecting to a database, it’s important that you have MySQL installed and configured on your machine. If this is not the case, please consult the <a href="https://dev.mysql.com/doc/refman/5.7/en/installing.html" target="_blank" rel="noopener">installation instructions on their home page</a>.</p>
<p>The next thing we need to do is to create a database and a database table to work with. You can do this using a<br>graphical interface, such as <a href="https://www.phpmyadmin.net/" target="_blank" rel="noopener">phpMyAdmin</a>, or using the command line. For this article I’ll be using a database called <code>sitepoint</code> and a table called <code>employees</code>. Here’s a dump of the database, so that you can get up and running quickly, if you wish to follow along:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE employees (</span><br><span class="line">  id int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  name varchar(50),</span><br><span class="line">  location varchar(50),</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=5 ;</span><br><span class="line"></span><br><span class="line">INSERT INTO employees (id, name, location) VALUES</span><br><span class="line">(1, &apos;Jasmine&apos;, &apos;Australia&apos;),</span><br><span class="line">(2, &apos;Jay&apos;, &apos;India&apos;),</span><br><span class="line">(3, &apos;Jim&apos;, &apos;Germany&apos;),</span><br><span class="line">(4, &apos;Lesley&apos;, &apos;Scotland&apos;);</span><br></pre></td></tr></table></figure>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2017/07/1499611321insert-data-into-table-phpmyadmin.png" alt="Using MySQL with Node.js &amp; the mysql JavaScript Client"></p>
<h2 id="Connecting-to-the-Database"><a href="#Connecting-to-the-Database" class="headerlink" title="Connecting to the Database"></a>Connecting to the Database</h2><p>Now, let’s create a file called <code>app.js</code> in our <code>mysql-test</code> directory and see how to connect to MySQL from Node.js.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line">const mysql = require(&apos;mysql&apos;);</span><br><span class="line"></span><br><span class="line">// First you need to create a connection to the db</span><br><span class="line">const con = mysql.createConnection(&#123;</span><br><span class="line">  host: &apos;localhost&apos;,</span><br><span class="line">  user: &apos;user&apos;,</span><br><span class="line">  password: &apos;password&apos;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">con.connect((err) =&gt; &#123;</span><br><span class="line">  if(err)&#123;</span><br><span class="line">    console.log(&apos;Error connecting to Db&apos;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&apos;Connection established&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">con.end((err) =&gt; &#123;</span><br><span class="line">  // The connection is terminated gracefully</span><br><span class="line">  // Ensures all previously enqueued queries are still</span><br><span class="line">  // before sending a COM_QUIT packet to the MySQL server.</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now open up a terminal and enter <code>node app.js</code>. Once the connection is successfully established you should be able to see the ‘Connection established’ message in the console. If something goes wrong (for example you enter the wrong password), a callback is fired, which is passed an instance of the JavaScript Error object (<code>err</code>). Try logging this to the console to see what additional useful information it contains.</p>
<h3 id="Using-Grunt-to-Watch-the-Files-for-Changes"><a href="#Using-Grunt-to-Watch-the-Files-for-Changes" class="headerlink" title="Using Grunt to Watch the Files for Changes"></a>Using Grunt to Watch the Files for Changes</h3><p>Running <code>node app.js</code> by hand every time we make a change to our code is going to get a bit tedious, so let’s automate that. This part isn’t necessary to follow along with the rest of the tutorial, but will certainly save you some keystrokes.</p>
<p>Let’s start off by installing a couple of packages:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev grunt grunt-contrib-watch grunt-execute</span><br></pre></td></tr></table></figure>
<p><a href="http://gruntjs.com/" target="_blank" rel="noopener">Grunt</a> is the well-know JavaScript task runner, <a href="https://www.npmjs.com/package/grunt-contrib-watch" target="_blank" rel="noopener">grunt-contrib-watch</a> runs a pre-defined task whenever a watched file changes, and <a href="https://www.npmjs.com/package/grunt-execute" target="_blank" rel="noopener">grunt-execute</a> can be used to run the <code>node app.js</code> command.</p>
<p>Once these are installed, create a file called <code>Gruntfile.js</code> in the project root and add the following code.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Gruntfile.js</span><br><span class="line"></span><br><span class="line">module.exports = (grunt) =&gt; &#123;</span><br><span class="line">  grunt.initConfig(&#123;</span><br><span class="line">    execute: &#123;</span><br><span class="line">      target: &#123;</span><br><span class="line">        src: [&apos;app.js&apos;]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">      scripts: &#123;</span><br><span class="line">        files: [&apos;app.js&apos;],</span><br><span class="line">        tasks: [&apos;execute&apos;],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-watch&apos;);</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-execute&apos;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Now run <code>grunt watch</code> and make a change to <code>app.js</code>. Grunt should detect the change and re-run the <code>node app.js</code> command.</p>
<h2 id="Executing-Queries"><a href="#Executing-Queries" class="headerlink" title="Executing Queries"></a>Executing Queries</h2><h3 id="Reading"><a href="#Reading" class="headerlink" title="Reading"></a>Reading</h3><p>Now that you know how to establish a connection to MySQL from Node.js, let’s see how to execute SQL queries. We’ll start by specifying the database name (<code>sitepoint</code>) in the <code>createConnection</code> command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const con = mysql.createConnection(&#123;</span><br><span class="line">  host: &apos;localhost&apos;,</span><br><span class="line">  user: &apos;user&apos;,</span><br><span class="line">  password: &apos;password&apos;,</span><br><span class="line">  database: &apos;sitepoint&apos;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Once the connection is established we’ll use the connection variable to execute a query against the database table <code>employees</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">con.query(&apos;SELECT * FROM employees&apos;, (err,rows) =&gt; &#123;</span><br><span class="line">  if(err) throw err;</span><br><span class="line"></span><br><span class="line">  console.log(&apos;Data received from Db:\n&apos;);</span><br><span class="line">  console.log(rows);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>When you run <code>app.js</code> (either using <code>grunt-watch</code> or by typing <code>node app.js</code> into your terminal), you should be able to see the data returned from database logged to the terminal.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; id: 1, name: &apos;Jasmine&apos;, location: &apos;Australia&apos; &#125;,</span><br><span class="line">  &#123; id: 2, name: &apos;Jay&apos;, location: &apos;India&apos; &#125;,</span><br><span class="line">  &#123; id: 3, name: &apos;Jim&apos;, location: &apos;Germany&apos; &#125;,</span><br><span class="line">  &#123; id: 4, name: &apos;Lesley&apos;, location: &apos;Scotland&apos; &#125; ]</span><br></pre></td></tr></table></figure>
<p>Data returned from the MySQL database can be parsed by simply lopping over the <code>rows</code> object.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows.forEach( (row) =&gt; &#123; </span><br><span class="line">  console.log(`$&#123;row.name&#125; is in $&#123;row.location&#125;`); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Creating"><a href="#Creating" class="headerlink" title="Creating"></a>Creating</h3><p>You can execute an insert query against a database, like so:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const employee = &#123; name: &apos;Winnie&apos;, location: &apos;Australia&apos; &#125;;</span><br><span class="line">con.query(&apos;INSERT INTO employees SET ?&apos;, employee, (err, res) =&gt; &#123;</span><br><span class="line">  if(err) throw err;</span><br><span class="line"></span><br><span class="line">  console.log(&apos;Last insert ID:&apos;, res.insertId);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Note how we can get the ID of the inserted record using the callback parameter.</p>
<h3 id="Updating"><a href="#Updating" class="headerlink" title="Updating"></a>Updating</h3><p>Similarly, when executing an update query, the number of rows affected can be retrieved using <code>result.affectedRows</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">con.query(</span><br><span class="line">  &apos;UPDATE employees SET location = ? Where ID = ?&apos;,</span><br><span class="line">  [&apos;South Africa&apos;, 5],</span><br><span class="line">  (err, result) =&gt; &#123;</span><br><span class="line">    if (err) throw err;</span><br><span class="line"></span><br><span class="line">    console.log(`Changed $&#123;result.changedRows&#125; row(s)`);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="Destroying"><a href="#Destroying" class="headerlink" title="Destroying"></a>Destroying</h3><p>Same thing goes for a delete query:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">con.query(</span><br><span class="line">  &apos;DELETE FROM employees WHERE id = ?&apos;, [5], (err, result) =&gt; &#123;</span><br><span class="line">    if (err) throw err;</span><br><span class="line"></span><br><span class="line">    console.log(`Deleted $&#123;result.affectedRows&#125; row(s)`);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="Advanced-Use"><a href="#Advanced-Use" class="headerlink" title="Advanced Use"></a>Advanced Use</h2><p>I’d like to finish off by looking at how the mysql module handles stored procedures and the escaping of user input.</p>
<h3 id="Stored-Procedures"><a href="#Stored-Procedures" class="headerlink" title="Stored Procedures"></a>Stored Procedures</h3><p>Put simply, a stored procedure is a procedure (written in, for example, SQL) stored in a database which can be called by the database engine and connected programming languages. If you are in need of a refresher, then please check out <a href="http://www.sitepoint.com/stored-procedures-mysql-php/" target="_blank" rel="noopener">this excellent article</a>.</p>
<p>Let’s create a stored procedure for our <code>sitepoint</code> database which fetches all the employee details. We’ll call it <code>sp_getall</code> . To do this, you’ll need some kind of interface to the database. I’m using <a href="http://www.phpmyadmin.net/home_page/index.php" target="_blank" rel="noopener">phpMyAdmin</a>. Run the following query on the sitepoint database:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_getall`()</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT id, name, location FROM employees;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>This will create and store the procedure in the <code>information_schema</code> database in the <code>ROUTINES</code> table.</p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2017/07/1499614150stored-procedure-phpmyadmin.png" alt="Stored procedure phpMyAdmin"></p>
<p>Next, establish a connection and use the connection object to call the stored procedure as shown:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">con.query(&apos;CALL sp_getall()&apos;,function(err, rows)&#123;</span><br><span class="line">  if (err) throw err;</span><br><span class="line"></span><br><span class="line">  console.log(&apos;Data received from Db:\n&apos;);</span><br><span class="line">  console.log(rows);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Save the changes and run the file. Once executed you should be able to view the data returned from the database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ [ &#123; id: 1, name: &apos;Jasmine&apos;, location: &apos;Australia&apos; &#125;,</span><br><span class="line">    &#123; id: 2, name: &apos;Jay&apos;, location: &apos;India&apos; &#125;,</span><br><span class="line">    &#123; id: 3, name: &apos;Jim&apos;, location: &apos;Germany&apos; &#125;,</span><br><span class="line">    &#123; id: 4, name: &apos;Lesley&apos;, location: &apos;Scotland&apos; &#125; ],</span><br><span class="line">  &#123; fieldCount: 0,</span><br><span class="line">    affectedRows: 0,</span><br><span class="line">    insertId: 0,</span><br><span class="line">    serverStatus: 34,</span><br><span class="line">    warningCount: 0,</span><br><span class="line">    message: &apos;&apos;,</span><br><span class="line">    protocol41: true,</span><br><span class="line">    changedRows: 0 &#125; ]</span><br></pre></td></tr></table></figure>
<p>Along with the data, it returns some additional information, such as the affected number of rows, <code>insertId</code> etc. You need to iterate over the 0th index of the returned data to get employee details separated from the rest of the information.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows[0].forEach( (row) =&gt; &#123;</span><br><span class="line">  console.log(`$&#123;row.name&#125; is in $&#123;row.location&#125;`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now lets consider a stored procedure which requires an input parameter.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_employee_detail`(</span><br><span class="line">  in employee_id int</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT name, location FROM employees where id = employee_id;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>Now we can pass the input parameter while making a call to the stored procedure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">con.query(&apos;CALL sp_get_employee_detail(1)&apos;, (err, rows) =&gt; &#123;</span><br><span class="line">  if(err) throw err;</span><br><span class="line"></span><br><span class="line">  console.log(&apos;Data received from Db:\n&apos;);</span><br><span class="line">  console.log(rows[0]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Most of the time when we try to insert a record into the database, we need the last inserted ID to be returned as an out parameter. Consider the following insert stored procedure with an out parameter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_insert_employee`(</span><br><span class="line">  out employee_id int,</span><br><span class="line">  in employee_name varchar(25),</span><br><span class="line">  in employee_location varchar(25)</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">  insert into employees(name, location)</span><br><span class="line">  values(employee_name, employee_location);</span><br><span class="line">  set employee_id = LAST_INSERT_ID();</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>To make a procedure call with an out parameter, we first need to enable multiple calls while creating the connection. So, modify the connection by setting the multiple statement execution to <code>true</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const con = mysql.createConnection(&#123;</span><br><span class="line">  host: &apos;localhost&apos;,</span><br><span class="line">  user: &apos;user&apos;,</span><br><span class="line">  password: &apos;password&apos;,</span><br><span class="line">  database: &apos;sitepoint&apos;,</span><br><span class="line">  multipleStatements: true</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Next when making a call to the procedure, set an out parameter and pass it in.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">con.query(</span><br><span class="line">  &quot;SET @employee_id = 0; CALL sp_insert_employee(@employee_id, &apos;Ron&apos;, &apos;USA&apos;); SELECT @employee_id&quot;,</span><br><span class="line">  (err, rows) =&gt; &#123;</span><br><span class="line">    if (err) throw err;</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Data received from Db:\n&apos;);</span><br><span class="line">    console.log(rows);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>As seen in the above code, we have set an out parameter <code>@employee_id</code> and passed it while making a call to the stored procedure. Once the call has been made we need to select the out parameter to access the returned ID.</p>
<p>Run <code>app.js</code>. On successful execution you should be able to see the selected out parameter along with various other information. <code>rows[2]</code> should give you access to the selected out parameter.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; &apos;@employee_id&apos;: 6 &#125; ]</span><br></pre></td></tr></table></figure>
<h3 id="Escaping-User-Input"><a href="#Escaping-User-Input" class="headerlink" title="Escaping User Input"></a>Escaping User Input</h3><p>In order to avoid SQL Injection attacks, you should <strong>always</strong> escape any data from user land before using it inside a SQL query. Let’s demonstrate why:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const userLandVariable = &apos;4 &apos;;</span><br><span class="line"></span><br><span class="line">con.query(</span><br><span class="line">  `SELECT * FROM employees WHERE id = $&#123;userLandVariable&#125;`,</span><br><span class="line">  (err, rows) =&gt; &#123;</span><br><span class="line">    if(err) throw err;</span><br><span class="line">    console.log(rows);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>This seems harmless enough and even returns the correct result:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; id: 4, name: &apos;Lesley&apos;, location: &apos;Scotland&apos; &#125;</span><br></pre></td></tr></table></figure>
<p>However, if we change the userLandVariable to this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const userLandVariable = &apos;4 OR 1=1&apos;;</span><br></pre></td></tr></table></figure>
<p>we suddenly have access to the entire data set. If we then change it to this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const userLandVariable = &apos;4; DROP TABLE employees&apos;;</span><br></pre></td></tr></table></figure>
<p>then we’re in proper trouble!</p>
<p>The good news is that help is at hand. You just have to use the <a href="https://www.npmjs.com/package/mysql#escaping-query-values" target="_blank" rel="noopener">mysql.escape</a> method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">con.query(</span><br><span class="line">  `SELECT * FROM employees WHERE id = $&#123;mysql.escape(userLandVariable)&#125;`,</span><br><span class="line">  function(err, rows)&#123; ... &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Or by using a question mark placeholder, as we did in the examples at the beginning of the article:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> con.query(</span><br><span class="line">  &apos;SELECT * FROM employees WHERE id = ?&apos;,</span><br><span class="line">  [userLandVariable],</span><br><span class="line">  (err, rows) =&gt; &#123; ... &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="Why-Not-Just-USE-an-ORM"><a href="#Why-Not-Just-USE-an-ORM" class="headerlink" title="Why Not Just USE an ORM?"></a>Why Not Just USE an ORM?</h2><p>As you may have noticed, a couple of people in the comments are suggesting using an ORM. Before we get into the pros and cons of this approach, let’s take a second to look at what ORMs are. The following is taken from <a href="https://stackoverflow.com/a/1279678/1136887" target="_blank" rel="noopener">an answer on Stack Overflow</a>:</p>
<blockquote>
<p>Object-Relational Mapping (ORM) is a technique that lets you query and manipulate data from a database using an object-oriented paradigm. When talking about ORM, most people are referring to a library that implements the Object-Relational Mapping technique, hence the phrase “an ORM”.</p>
</blockquote>
<p>So basically, this approach means you write your database logic in the domain-specific language of the ORM, as opposed to the vanilla approach we have been taking so far. Here’s a contrived example using <a href="http://docs.sequelizejs.com/" target="_blank" rel="noopener">Sequelize</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Employee.findAll().then(employees =&gt; &#123;</span><br><span class="line">  console.log(employees);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Contrasted with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">con.query(&apos;SELECT * FROM employees&apos;, (err,rows) =&gt; &#123;</span><br><span class="line">  if(err) throw err;</span><br><span class="line"></span><br><span class="line">  console.log(&apos;Data received from Db:\n&apos;);</span><br><span class="line">  console.log(rows);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Whether or not using an ORM makes sense for you, will depend very much on what you are working on and with whom. On the one hand, ORMS tend to make developers more productive, in part by abstracting away a large part of the SQL so that not everyone on the team needs to know how to write super efficient database specific queries. It is also easy to move to different database software, because you are developing to an abstraction.</p>
<p>On the other hand however, it is possible to write some really messy and inefficient SQL as a result of not understanding how the ORM does what it does. Performance is also an issue in that it’s much easier to optimize queries that don’t have to go through the ORM.</p>
<p>Whichever path you take is up to you, but if this is a decision you’re in the process of making, check out this Stack Overflow thread: <a href="https://stackoverflow.com/q/448684/1136887" target="_blank" rel="noopener">Why should you use an ORM?</a> as well as this post on SitePoint: <a href="https://www.sitepoint.com/3-javascript-orms-you-might-not-know/" target="_blank" rel="noopener">3 JavaScript ORMs You Might Not Know</a>.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, we’ve only scratched the surface of what the mysql client offers. For more detailed information, I would recommend reading the <a href="https://github.com/mysqljs/mysql" target="_blank" rel="noopener">official documentation</a>. There are other options too, such as <a href="https://github.com/sidorares/node-mysql2" target="_blank" rel="noopener">node-mysql2</a> and <a href="https://github.com/Sannis/node-mysql-libmysqlclient" target="_blank" rel="noopener">node-mysql-libmysqlclient</a>.</p>
<span>Source: </span><a href="https://www.sitepoint.com/using-node-mysql-javascript-client/" target="_blank" title="https://www.sitepoint.com/using-node-mysql-javascript-client/" class="post-from">https://www.sitepoint.com/using-node-mysql-javascript-client/</a></div></div></article></div></section><div class="wrap"><footer><div class="paginator"><a href="/2017/07/How-to-Create-a-Reddit-Clone-Using-React-and-Firebase.html" class="prev">NEXT</a><a href="/2017/07/10-react-mini-patterns.html" class="next">PREV</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://nthung2112.github.io">Hung Tan Nguyen</a>, unless otherwise noted.</p></div></footer></div><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-41935289-1",'auto');ga('send','pageview');</script><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script><script src="/js/zoom.js"></script><script src="/js/insight.js"></script></body></html>