<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title> Tìm hiểu về async và await đơn giản · Learn and Share</title><meta name="description" content="Tìm hiểu về async và await đơn giản - Hung Tan Nguyen"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#FB4D42"><meta name="google-site-verification" content="rk-Nc1c8xi1CdZ0ZQIVV-ifsndGrHanIuSHI-yTHZYE"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/zoom.css"><meta property="og:title" content="Tìm hiểu về async và await đơn giản"><meta property="og:image"><meta property="og:description" content="1. Giới thiệuVới các đặc tả JavaScript cũ, ta phải sử dụng các hàm phản hồi để xử lý các thao tác bất đồng bộ. Tuy nhiên việc này dẫn tới tình trạng callback hell khi ta có nhiều thao tác bất đồng bộ phải chờ nhau thực hiện. Call hell làm cho mã nguồn của ta rất rối và khó bảo trì.
12345678910111213141516function wait(ms, cb) &amp;#123;  setTimeout(cb, ms)&amp;#125;function main() &amp;#123;  console.log('sắp rồi...')  wait(2007, () =&amp;gt; &amp;#123;    console.log('chờ tí...')    wait(2012, () =&amp;gt; &amp;#123;      console.log('thêm chút nữa thôi...')      wait(2016, () =&amp;gt; &amp;#123;        console.log('xong rồi đấy!')      &amp;#125;)    &amp;#125;)  &amp;#125;)&amp;#125;
Vì vậy, với phiên bản ES6 (ES 2016), Promise đã được đưa vào mặc định nhằm giải quyết tình trạng callback hell. Với Promise, mã nguồn của ta sẽ trông gần giống với phong cách đồng bộ, kết quả là trông dễ theo dõi và bảo trì hơn. Tuy nhiên sử dụng Promise lại làm phát sinh vấn đề “khá” tương tự là Promise hell ( lol! JavaScript Heo! )."></head><body><div class="wrap"><div class="header"><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nthung2112" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item search-form-input"><div class="search-icon"><div class="search-icon__circle"></div><div class="search-icon__rectangle"></div></div></li></ul><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" placeholder="Type something..." class="ins-search-input"><span class="ins-close ins-selectable"><div class="close-icon"><div class="close-icon__x"></div><div class="close-icon__y"></div></div></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>var rootUrl = "/";
var contentUrl = '/content.json';
(function (window) {
  var INSIGHT_CONFIG = {
  TRANSLATION: {
      POSTS:'Posts',
      PAGES: 'Pages',
      CATEGORIES: 'Categories',
      TAGS: 'Tags',
      UNTITLED: '(Untitled)'
    },
    ROOT_URL: rootUrl,
    CONTENT_URL: contentUrl,
  };
  window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);</script></div></div><section class="container"><div class="post"><article class="post-block"><div class="wrap"><h1 class="post-title">Tìm hiểu về async và await đơn giản</h1><h2 class="post-subtitle"></h2><header class="post-info">Jan 10, 2017<div class="tags"><a href="/tags/javascript" class="tag-link">#javascript</a><a href="/tags/async" class="tag-link">#async</a><a href="/tags/await" class="tag-link">#await</a></div><div class="fb-ir-time"><time datetime="2017-01-10T13:03:38.000Z" class="op-modified"></time><time datetime="2017-01-10T13:03:38.000Z" class="op-published"></time></div></header></div><div class="wrap"><div class="post-content"><h3 id="1-Gioi-thieu"><a href="#1-Gioi-thieu" class="headerlink" title="1. Giới thiệu"></a>1. Giới thiệu</h3><p>Với các đặc tả JavaScript cũ, ta phải sử dụng các hàm phản hồi để xử lý các thao tác bất đồng bộ. Tuy nhiên việc này dẫn tới tình trạng <a href="https://stackoverflow.com/questions/25098066/what-is-callback-hell-and-how-and-why-rx-solves-it" target="_blank" rel="noopener">callback hell</a> khi ta có nhiều thao tác bất đồng bộ phải chờ nhau thực hiện. Call hell làm cho mã nguồn của ta rất rối và khó bảo trì.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(cb, ms)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sắp rồi...'</span>)</span><br><span class="line">  wait(<span class="number">2007</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'chờ tí...'</span>)</span><br><span class="line">    wait(<span class="number">2012</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">      wait(<span class="number">2016</span>, () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'xong rồi đấy!'</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Vì vậy, với phiên bản ES6 (ES 2016), <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">Promise</a> đã được đưa vào mặc định nhằm giải quyết tình trạng callback hell. Với Promise, mã nguồn của ta sẽ trông gần giống với phong cách đồng bộ, kết quả là trông dễ theo dõi và bảo trì hơn. Tuy nhiên sử dụng <code>Promise</code> lại làm phát sinh vấn đề “khá” tương tự là Promise hell ( lol! JavaScript Heo! ).<br><a id="more"></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sắp rồi...'</span>)</span><br><span class="line">  wait(<span class="number">2007</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'chờ tí...'</span>)</span><br><span class="line">    <span class="keyword">return</span> wait(<span class="number">2007</span>)</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">    <span class="keyword">return</span> wait(<span class="number">2012</span>)</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">    <span class="keyword">return</span> wait(<span class="number">2016</span>)</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'xong rồi đấy!'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Để giải quyết vấn đề đó, ở phiên bản ES7 (ES 2017), 1 khái niệm với 2 từ khóa mới được đưa vào là hàm async (<code>async / await</code>). Hàm async cho phép ta viết các thao tác bất đồng bộ với phong cách của các mã đồng bộ. Bằng cách viết như vậy, mã nguồn của ta trông sẽ sáng sủa, dễ đọc hơn và “dễ hiểu hơn”.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sắp rồi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2007</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'chờ tí...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2012</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2016</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'xong rồi đấy!'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-Cach-su-dung"><a href="#2-Cach-su-dung" class="headerlink" title="2. Cách sử dụng"></a>2. Cách sử dụng</h3><p>Để sử dụng hàm async, ta cần khai báo từ khóa <code>async</code> ngay trước từ khóa định nghĩa hàm. Tức là, với hàm định nghĩa với từ khóa <code>function</code> ta phải khai báo ngay trước <code>function</code>, với hàm mũi tên (arrow function) ta phải khai báo trước tập tham số đầu vào, với phương thức của lớp <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="noopener"><code>Class</code></a> thì ta phải khai báo ngay trước tên hàm.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// regular function</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">functionName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ret = <span class="keyword">await</span> <span class="keyword">new</span> Google().search(<span class="string">'JavaScript'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arrow function</span></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="string">'JS'</span>, <span class="string">'node.js'</span>].map(<span class="keyword">async</span> val =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> Google().search(val)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Google</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.apiKey = <span class="string">'...'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> search(keyword) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.searchApi(keyword)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Với từ khóa <code>async</code> này, ta có thể đợi các <code>Promise</code> (thao tác bất đồng bộ) xử lý trong hàm đó mà không tạm dùng luồng chính bằng từ khóa <code>await</code> như ví dụ trên.</p>
<p>Kết quả trả ra của hàm async luôn là một Promise dù bạn có gọi <code>await</code> - có xử lý bất đồng bộ hay không. Promise này sẽ ở trạng thái thành công với kết quả được trả ra với từ khóa <code>return</code> của hàm async, hoặc trạng thái thất bại với kết quả được đẩy qua từ khóa <code>throw</code> trong hàm async.</p>
<p>Như vậy, bản chất của hàm async chính là Promise. Nếu bạn chưa tìm hiểu về <code>Promise</code> thì nên đọc trước ở <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">bài viết này</a>.</p>
<p>Với Promise, ta có thể xử lý ngoại lệ với <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch" target="_blank" rel="noopener"><code>catch</code></a> khá đơn giản. Tuy nhiên cũng không dễ dàng theo dõi và dễ đọc. Nhưng với hàm async, việc này cực kì đơn giản bằng từ khóa <code>try catch</code> hệt như các thao tác đồng bộ.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">runner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sắp rồi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2007</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'chờ tí...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2012</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2016</span>)</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="number">2016</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> runner()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'xong rồi đấy!'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`có vấn đề tại <span class="subst">$&#123; e &#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Node v7</span></span><br><span class="line"><span class="comment">// `$ node --harmony-async-await test.js`</span></span><br><span class="line"><span class="comment">// Console: ... có vấn đề tại 2016</span></span><br></pre></td></tr></table></figure>
<p>Ngon! Rõ ràng là mã nguồn sử dụng <code>async/await</code> trông đơn giản, dễ theo dõi, “dễ hiểu” hơn và giải quyết được tình trạng callback - promise hell. Tuy nhiên, việc sử dụng nó cũng không phải lúc nào cũng đơn giản. Ta cùng nhau xem một số trường hợp dưới đây.</p>
<h3 id="3-Luu-y"><a href="#3-Luu-y" class="headerlink" title="3. Lưu ý"></a>3. Lưu ý</h3><h4 id="3-1-Quen-khai-bao-tu-khoa-async"><a href="#3-1-Quen-khai-bao-tu-khoa-async" class="headerlink" title="3.1. Quên khai báo từ khóa async"></a>3.1. Quên khai báo từ khóa <code>async</code></h4><p>Đương nhiên rồi, không khai báo từ khóa này thì ta không có hàm async được, không sử dụng <code>await</code> được rồi. Thường bạn sẽ nghĩ đơn giản là không thể nào quên được từ khóa này, nhưng tôi nghĩ đôi lúc có thể đấy. Ví dụ như với trường hợp khai báo một hàm trong một hàm async. Hàm khai báo trong hàm async cũng bắt buộc phải được khai báo với từ khóa <code>async</code> nếu như bạn muốn sử dụng như một hàm async.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">let</span> arr = [<span class="number">100</span>, <span class="number">300</span>, <span class="number">500</span>].map(<span class="function"><span class="params">val</span> =&gt;</span> wait(val))</span><br><span class="line">  arr.forEach(<span class="function"><span class="params">func</span> =&gt;</span> <span class="keyword">await</span> func)</span><br><span class="line">  <span class="comment">// ??? error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-Nhap-nhang-tu-khoa-await"><a href="#3-2-Nhap-nhang-tu-khoa-await" class="headerlink" title="3.2. Nhập nhằng từ khóa await"></a>3.2. Nhập nhằng từ khóa <code>await</code></h4><p>Có 2 tình huống điển hình cho trường hợp này là:</p>
<ul>
<li><p>Quên khai báo khi cần đợi một xử lý bất đồng bộ</p>
<p>Có gì đáng sợ không? Câu trả lời là có đấy! Nếu bạn không khai báo từ khóa này thì kết quả bạn nhận được sẽ là một <code>Promise</code> chứ không phải là kết quả thực thi của xử lý bất đồng bộ nhé.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">now</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Date</span>.now()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> t = now()</span><br><span class="line">  <span class="built_in">console</span>.log(t)</span><br><span class="line">   <span class="comment">// ??? `t` is a `Promise` instance</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Khai báo “thừa” trước một xử lý đồng bộ</p>
<p> Nếu mà sợ quên thì cứ khai báo bừa đi, đâu có sao? Ừ không sao đâu ngoại trừ 2 vấn đề là không biết cái nào là đồng bộ, cái nào là bất đồng bộ nữa, và hiệu quả đi xuống đấy. Mỗi khi bạn khai báo <code>await</code> thì mặc nhiên sau từ khóa đó là một <code>Promise</code>, nếu không phải là một <code>Promise</code> thì nó sẽ được gói lại vào <code>Promise</code> và được trả ra ngay với phương thức <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve" target="_blank" rel="noopener"><code>Promise.resolve(value)</code></a>. Rảnh quá ha, muốn lấy <code>1 + 0 = 1</code> mà phải đi đường vòng là tính tổng, rồi nhét vào Promise, rồi lại moi ra để sử dụng.</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// run with await</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'run with await'</span>)</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">1000000</span></span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'await'</span>)</span><br><span class="line">  <span class="keyword">while</span>(i-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> t = <span class="keyword">await</span> (<span class="number">1</span> + <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'await'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// run without await</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'run without await'</span>)</span><br><span class="line">  i = <span class="number">1000000</span></span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'normal'</span>)</span><br><span class="line">  <span class="keyword">while</span>(i-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> t = <span class="number">1</span> + <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'normal'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-3-Quen-xu-ly-loi"><a href="#3-3-Quen-xu-ly-loi" class="headerlink" title="3.3. Quên xử lý lỗi"></a>3.3. Quên xử lý lỗi</h4><p>Cũng như với việc quên <code>catch</code> lỗi khi sử dụng Promise, việc quên <code>try catch</code> để bắt lỗi với hàm async cũng có thể xảy ra. Nếu bạn quên không bắt lỗi, thì khi đoạn mã bất đồng của bạn xảy ra lỗi có thể làm chương trình của bạn bị dừng lại.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ms &gt; <span class="number">2015</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ms)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sắp rồi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2007</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'chờ tí...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2012</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'thêm chút nữa thôi...'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2016</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'xong rồi đấy!'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-Mat-tinh-song-song"><a href="#3-4-Mat-tinh-song-song" class="headerlink" title="3.4. Mất tính song song"></a>3.4. Mất tính song song</h4><p>Cái này có vẻ là căng nhất, bạn cứ khai báo <code>await</code> tuần tự đi rồi chương trình của bạn sẽ chậm như con rùa. hahaaa. Vì mỗi lần khai báo <code>await</code> như vậy là bạn cần phải chờ cho xử lý của await kết thúc. Kết quả là bạn có 1 con rùa chạy tuần tự qua từng nấc thang.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'wait3s'</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">await</span> wait(<span class="number">2000</span>)</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'wait3s'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Với đoạn mã trên bạn sẽ mất tổng cộng là <code>1 + 2 = 3s</code> để thực thi. Vì bạn phải chờ từng hàm <code>wait</code> một. Vậy làm sao để tránh được tình trạng trên? Câu trả lời là cứ cho xử lý bất đồng bộ chạy trước đi rồi lấy kết quả sau. Vì <code>Promise</code> có thể cho phép ta lấy kết quả bất cứ khi nào mà nó ở trạng thái cuối cùng, nên ta có thể chạy nó trước rồi lấy sau cũng không sao cả.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'wait2s'</span>)</span><br><span class="line">  <span class="keyword">let</span> w1 = wait(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">let</span> w2 = wait(<span class="number">2000</span>)</span><br><span class="line">  <span class="keyword">await</span> w1</span><br><span class="line">  <span class="keyword">await</span> w2</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'wait2s'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Như đoạn mã này, ta chỉ mất <code>2s</code> để thực hiện vì đoạn <code>wait</code> của ta được thực thi song song. Ngoài cách <code>await</code> từng <code>Promise</code> như trên ta có thể sử dụng <a href="https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="noopener"><code>Promise.all</code></a> để song song hóa các Promise.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'wait2s'</span>)</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all([wait(<span class="number">1000</span>), wait(<span class="number">2000</span>)])</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'wait2s'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lúc này, có thể bạn đang nghĩ <code>Promise.all</code> và <code>await</code> từng Promise là như nhau, nhưng nó khác nhau chút đấy. <code>Promise.all</code> chỉ ở trạng thái thành công khi mà tất cả các Promise được truyền vào xử lý thành công, còn nó sẽ ở trạng thái lỗi khi một trong các Promise truyền vào bị lỗi. Như vậy, nếu bạn muốn bỏ qua các Promise lỗi thì bạn không thể sử dụng <code>Promise.all</code> được đâu. Lúc đó bắt buộc bạn phải sử dụng <code>await</code> kèm với <code>try catch</code> cho từng Promise của bạn.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ms &gt; <span class="number">2000</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ms)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(r, ms))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dur = [<span class="number">1000</span>, <span class="number">2000</span>, <span class="number">3000</span>, <span class="number">4000</span>]</span><br><span class="line">  <span class="keyword">let</span> all = dur.map(<span class="function"><span class="params">ms</span> =&gt;</span> wait(ms))</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.all(all)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Promise.all - done'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Promise.all:'</span>, e)  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> each = dur.map(<span class="function"><span class="params">ms</span> =&gt;</span> wait(ms))</span><br><span class="line">  each.forEach(<span class="keyword">async</span> (func, index) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> func</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'each - done:'</span>, dur[index])</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">'each:'</span>, e)  </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-Nen-tang-trinh-duyet-ho-tro"><a href="#4-Nen-tang-trinh-duyet-ho-tro" class="headerlink" title="4. Nền tảng/ trình duyệt hỗ trợ"></a>4. Nền tảng/ trình duyệt hỗ trợ</h3><p>  Thời điểm này (2016/10), các nền tảng và trình duyệt sau đã hỗ trợ hàm async.</p>
<ul>
<li>Node.js v7.0 với cờ <code>--harmony-async-await</code></li>
<li>Chrome v5.55</li>
<li><p>Microsoft Edge v21.10547</p>
<p>Nếu bạn muốn chạy ở các nền tảng/ trình duyệt chưa hỗ trợ thì có thể dùng babel để chuyển đổi:</p>
</li>
<li><p>Babel <a href="https://babeljs.io/docs/plugins/transform-async-to-generator/" target="_blank" rel="noopener">async-2-generator plugin</a></p>
</li>
</ul>
<h3 id="5-Ket-luan"><a href="#5-Ket-luan" class="headerlink" title="5. Kết luận"></a>5. Kết luận</h3><p>  Bản chất của hàm async chính là <code>Promise</code>, vì vậy để sử dụng được nó ta cần phải sử dụng <code>Promise</code> cho việc xử lý các thao tác bất đồng bộ. Bạn không thể nào sài <code>await</code> để đợi các hàm có sử dụng hàm phản hồi (callback) được, mà bắt buộc phải gắn nó với một Promise trước khi sử dụng <code>await</code>.</p>
<p>  Mặc dù hàm async có cú pháp rất rõ ràng, ta cũng cần phải lưu ý tránh khai báo thừa thiếu các từ khóa gây lỗi, gây hiểu lầm về lô-gíc chương trình. Và đặc biệt lưu ý tới khả năng làm mất đi tính song song của chương trình.</p>
<p>  Với sự tiện dụng của hàm async, ta nên cố gắng sử dụng nó ngay từ bây giờ để giảm thiểu việc bảo trì sau này. Với các nền tảng/ trình duyệt chưa hỗ trợ thì ta có thể chuyển đổi bằng <a href="https://babeljs.io/" target="_blank" rel="noopener">babel</a>. Hiện tại Node v7 vẫn đang sử dụng Chrome v5.54 nên muốn sử dụng được async/await, ta buộc phải chạy với cờ <code>--harmony-async-await</code> và hiệu năng, bộ nhớ được sử dụng vẫn chưa hiệu quả, không khuyến khích cho các sản phẩm thực tế. Tuy nhiên, rất có thể Node v8 sẽ sử dụng phiên bản Chrome v5.55 và cho phép ta thực hiện mặc định các hàm async.</p>
<p> <code>async</code> chúc các bạn <code>await</code> vui vẻ!</p>
</div></div></article></div></section><div class="wrap"><footer><div class="paginator"><a href="/2017/07/10-react-mini-patterns.html" class="prev">NEXT</a><a href="/2017/01/Javascript-Bat-ngo-ve-mang-trong-javascript.html" class="next">PREV</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://nthung2112.github.io">Hung Tan Nguyen</a>, unless otherwise noted.</p></div></footer></div><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-41935289-1",'auto');ga('send','pageview');</script><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script><script src="/js/zoom.js"></script><script src="/js/insight.js"></script></body></html>